<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N8N Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
            --blue: #6366f1;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 1rem;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* HEADER */
        header {
            background: linear-gradient(135deg, var(--blue), #4f46e5);
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
        }
        header h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-dot.healthy { background: var(--green); }
        .status-dot.warning { background: var(--yellow); }
        .status-dot.critical { background: var(--red); }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
        .last-update { font-size: 0.75rem; color: rgba(255,255,255,0.7); margin-top: 0.5rem; }
        
        /* ALERTAS */
        .alerts {
            background: rgba(239,68,68,0.1);
            border: 1px solid var(--red);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .alerts.hidden { display: none; }
        .alerts h3 { font-size: 0.875rem; margin-bottom: 0.5rem; color: var(--red); }
        .alert-item {
            font-size: 0.875rem;
            padding: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .alert-icon { font-size: 1rem; }
        
        /* CARDS */
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
        .card {
            background: var(--card);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .card-title { font-size: 1rem; font-weight: 600; }
        .card-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .card-indicator.green { background: var(--green); }
        .card-indicator.yellow { background: var(--yellow); }
        .card-indicator.red { background: var(--red); }
        
        /* METRICAS */
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: var(--muted); font-size: 0.875rem; }
        .metric-value { font-weight: 600; }
        .metric-value.good { color: var(--green); }
        .metric-value.warn { color: var(--yellow); }
        .metric-value.bad { color: var(--red); }
        
        /* CONTAINERS */
        .container-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .container-item:last-child { border-bottom: none; }
        .container-name { font-size: 0.875rem; }
        .container-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        .container-status.healthy { background: rgba(16,185,129,0.2); color: var(--green); }
        .container-status.running { background: rgba(99,102,241,0.2); color: var(--blue); }
        .container-status.unhealthy { background: rgba(239,68,68,0.2); color: var(--red); }
        .container-status.stopped { background: rgba(239,68,68,0.2); color: var(--red); }
        
        /* LOADING */
        .loading { text-align: center; padding: 2rem; color: var(--muted); }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--card);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ERROR */
        .error-msg {
            background: rgba(239,68,68,0.1);
            border: 1px solid var(--red);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .error-msg.hidden { display: none; }
        
        footer {
            text-align: center;
            padding: 1rem;
            color: var(--muted);
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Infraestrutura N8N</h1>
            <div class="header-row">
                <div class="status-badge">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Carregando...</span>
                </div>
                <div class="status-badge">
                    Atualiza em <span id="countdown">60</span>s
                </div>
            </div>
            <div class="last-update" id="lastUpdate"></div>
        </header>
        
        <div class="error-msg hidden" id="errorMsg">
            Erro ao carregar dados. Tentando novamente...
        </div>
        
        <div class="alerts hidden" id="alertsBox">
            <h3>‚ö†Ô∏è Alertas</h3>
            <div id="alertsList"></div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Carregando dados...</p>
        </div>
        
        <div class="cards" id="cards" style="display:none;"></div>
        
        <footer>Dashboard V5 Simple | Atualiza a cada 60s</footer>
    </div>

    <script>
        const GIST_URL = 'https://api.github.com/gists/6f8186d15f6e65b08c04642242607d6e';
        let countdown = 60;

        async function loadData() {
            try {
                const res = await fetch(GIST_URL);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                
                const gist = await res.json();
                const content = gist.files['dashboard-status.json'].content;
                const data = JSON.parse(content);
                
                renderDashboard(data);
                document.getElementById('errorMsg').classList.add('hidden');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('cards').style.display = 'grid';
                
            } catch (e) {
                console.error('Erro:', e);
                document.getElementById('errorMsg').classList.remove('hidden');
            }
        }

        function renderDashboard(data) {
            // Status
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            dot.className = 'status-dot ' + (data.status || 'healthy');
            txt.textContent = data.status === 'healthy' ? 'Operacional' : 
                              data.status === 'warning' ? 'Atencao' : 'Critico';
            
            // Ultima atualizacao
            if (data.timestamp) {
                const d = new Date(data.timestamp);
                document.getElementById('lastUpdate').textContent = 
                    'Ultima atualizacao: ' + d.toLocaleString('pt-BR');
            }
            
            // Alertas
            const alertsBox = document.getElementById('alertsBox');
            const alertsList = document.getElementById('alertsList');
            if (data.alerts && data.alerts.length > 0) {
                alertsBox.classList.remove('hidden');
                alertsList.innerHTML = data.alerts.map(a => 
                    `<div class="alert-item">
                        <span class="alert-icon">${a.level === 'critical' ? 'üî¥' : 'üü°'}</span>
                        <span>${a.message}</span>
                    </div>`
                ).join('');
            } else {
                alertsBox.classList.add('hidden');
            }
            
            // Cards
            const cards = document.getElementById('cards');
            cards.innerHTML = '';
            
            // 1. RECURSOS DO SISTEMA
            const r = data.resources || {};
            const cpuClass = r.cpu_percent > 90 ? 'bad' : r.cpu_percent > 70 ? 'warn' : 'good';
            const ramClass = r.ram_percent > 90 ? 'bad' : r.ram_percent > 70 ? 'warn' : 'good';
            const diskClass = r.disk_percent > 90 ? 'bad' : r.disk_percent > 70 ? 'warn' : 'good';
            const sysIndicator = (r.cpu_percent > 90 || r.ram_percent > 90 || r.disk_percent > 90) ? 'red' :
                                 (r.cpu_percent > 70 || r.ram_percent > 70 || r.disk_percent > 70) ? 'yellow' : 'green';
            
            cards.innerHTML += `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Recursos do Sistema</span>
                        <span class="card-indicator ${sysIndicator}"></span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">CPU</span>
                        <span class="metric-value ${cpuClass}">${r.cpu_percent || 0}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Memoria</span>
                        <span class="metric-value ${ramClass}">${r.ram_percent || 0}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Disco</span>
                        <span class="metric-value ${diskClass}">${r.disk_percent || 0}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">RAM Usada</span>
                        <span class="metric-value">${r.ram_used_gb || 0} / ${r.ram_total_gb || 0} GB</span>
                    </div>
                </div>
            `;
            
            // 2. CONTAINERS
            const containers = data.containers || [];
            const unhealthy = containers.filter(c => c.health === 'unhealthy' || c.status !== 'running');
            const containerIndicator = unhealthy.length > 0 ? 'red' : 'green';
            
            cards.innerHTML += `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Containers Docker</span>
                        <span class="card-indicator ${containerIndicator}"></span>
                    </div>
                    ${containers.map(c => `
                        <div class="container-item">
                            <span class="container-name">${c.name}</span>
                            <span class="container-status ${c.health || c.status}">${c.health || c.status}</span>
                        </div>
                    `).join('') || '<p style="color:var(--muted);font-size:0.875rem;">Nenhum container</p>'}
                </div>
            `;
            
            // 3. WORKFLOWS N8N
            const wf = data.workflows || {};
            const ex = wf.executions_24h || {};
            const wfIndicator = ex.error > 5 ? 'red' : ex.error > 0 ? 'yellow' : 'green';
            
            cards.innerHTML += `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Workflows N8N</span>
                        <span class="card-indicator ${wfIndicator}"></span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total</span>
                        <span class="metric-value">${wf.total || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Ativos</span>
                        <span class="metric-value good">${wf.active || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Sucessos (24h)</span>
                        <span class="metric-value good">${ex.success || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Erros (24h)</span>
                        <span class="metric-value ${ex.error > 0 ? 'bad' : 'good'}">${ex.error || 0}</span>
                    </div>
                </div>
            `;
            
            // 4. BACKUPS
            const bk = data.backups || {};
            const hasDaily = bk.last_daily !== null;
            const bkIndicator = hasDaily ? 'green' : 'yellow';
            
            cards.innerHTML += `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Backups</span>
                        <span class="card-indicator ${bkIndicator}"></span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Ultimo Diario</span>
                        <span class="metric-value">${formatDate(bk.last_daily)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Ultimo Semanal</span>
                        <span class="metric-value">${formatDate(bk.last_weekly)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Dropbox</span>
                        <span class="metric-value">${bk.dropbox_used_gb || 0} GB</span>
                    </div>
                </div>
            `;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Nunca';
            try {
                return new Date(dateStr).toLocaleString('pt-BR');
            } catch {
                return dateStr;
            }
        }

        function updateCountdown() {
            document.getElementById('countdown').textContent = countdown;
            countdown--;
            if (countdown < 0) {
                countdown = 60;
                loadData();
            }
        }

        // Iniciar
        loadData();
        setInterval(updateCountdown, 1000);
    </script>
</body>
</html>
